<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Creador de Cartas Pixel PRO</title>

<style>
body{
    background:#111;
    color:white;
    font-family:Arial;
    text-align:center;
}

.controls{
    margin-bottom:20px;
}

input{
    margin:5px;
}

.card-wrapper{
    display:inline-block;
    position:relative;
}

.card-container{
    position:relative;
    overflow:hidden;
}

.background{
    position:absolute;
    top:0;
    left:0;
    cursor:grab;
}

.overlay{
    position:absolute;
    top:0;
    left:0;
    pointer-events:none;
}

canvas{
    image-rendering: pixelated;
}
</style>
</head>
<body>

<h2>ðŸŽ´ Creador de Cartas Pixel PRO</h2>

<div class="controls">

Overlay PNG:
<input type="file" id="overlayInput" accept="image/png"><br>

Imagen Fondo:
<input type="file" id="backgroundInput" accept="image/*"><br>

Zoom Fondo:
<input type="range" id="zoomRange" min="1" max="2" step="0.01" value="1"><br>

Pixelado (1â€“10):
<input type="range" id="pixelRange" min="1" max="10" value="1">
<span id="pixelValue">1</span><br>

ResoluciÃ³n Exportar:
<select id="resolution">
<option value="1">Normal</option>
<option value="2">HD x2</option>
</select><br>

<button onclick="downloadCard()">ðŸ“¥ Descargar PNG</button>

</div>

<div class="card-wrapper">
    <div class="card-container" id="cardContainer">
        <img id="backgroundImage" class="background">
        <img id="overlayImage" class="overlay">
    </div>

    <!-- Canvas para pixelado -->
    <canvas id="pixelCanvas"></canvas>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>

const overlayInput = document.getElementById("overlayInput");
const backgroundInput = document.getElementById("backgroundInput");
const overlayImage = document.getElementById("overlayImage");
const backgroundImage = document.getElementById("backgroundImage");
const cardContainer = document.getElementById("cardContainer");

const pixelRange = document.getElementById("pixelRange");
const pixelCanvas = document.getElementById("pixelCanvas");
const ctx = pixelCanvas.getContext("2d");

let bgScale = 1;
let posX = 0;
let posY = 0;
let isDragging = false;
let startX, startY;

// Cargar Overlay
overlayInput.addEventListener("change", e=>{
    const reader = new FileReader();
    reader.onload = event=>{
        overlayImage.src = event.target.result;
        overlayImage.onload = ()=>{
            cardContainer.style.width = overlayImage.width+"px";
            cardContainer.style.height = overlayImage.height+"px";
            overlayImage.style.width = "100%";
            overlayImage.style.height = "100%";
            renderPixelated();
        }
    }
    reader.readAsDataURL(e.target.files[0]);
});

// Cargar Fondo
backgroundInput.addEventListener("change", e=>{
    const reader = new FileReader();
    reader.onload = event=>{
        backgroundImage.src = event.target.result;
        backgroundImage.onload = ()=>{
            fitBackground();
            renderPixelated();
        }
    }
    reader.readAsDataURL(e.target.files[0]);
});

function fitBackground(){
    backgroundImage.style.height = cardContainer.offsetHeight+"px";
    backgroundImage.style.width = "auto";
    backgroundImage.style.transform = 
        `translate(${posX}px,${posY}px) scale(${bgScale})`;
}

// Zoom
document.getElementById("zoomRange").addEventListener("input", e=>{
    bgScale = e.target.value;
    fitBackground();
    renderPixelated();
});

// Drag Fondo
backgroundImage.addEventListener("mousedown", e=>{
    isDragging = true;
    startX = e.clientX - posX;
    startY = e.clientY - posY;
});

document.addEventListener("mousemove", e=>{
    if(!isDragging) return;
    posX = e.clientX - startX;
    posY = e.clientY - startY;
    fitBackground();
    renderPixelated();
});

document.addEventListener("mouseup", ()=> isDragging=false);

// Slider Pixelado
pixelRange.addEventListener("input", ()=>{
    document.getElementById("pixelValue").innerText = pixelRange.value;
    renderPixelated();
});

function renderPixelated(){

    const level = parseInt(pixelRange.value);

    html2canvas(cardContainer,{backgroundColor:null}).then(canvas=>{

        const width = canvas.width;
        const height = canvas.height;

        const scale = 1 / level;

        const tempCanvas = document.createElement("canvas");
        const tempCtx = tempCanvas.getContext("2d");

        tempCanvas.width = width * scale;
        tempCanvas.height = height * scale;

        tempCtx.imageSmoothingEnabled = false;
        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

        pixelCanvas.width = width;
        pixelCanvas.height = height;

        ctx.imageSmoothingEnabled = false;
        ctx.clearRect(0,0,width,height);
        ctx.drawImage(tempCanvas, 0, 0, width, height);
    });
}

// Descargar
function downloadCard(){
    const scaleFactor = document.getElementById("resolution").value;

    html2canvas(pixelCanvas,{
        scale: scaleFactor,
        backgroundColor:null
    }).then(canvas=>{
        const link=document.createElement("a");
        link.download="carta_pixel.png";
        link.href=canvas.toDataURL();
        link.click();
    });
}

</script>

</body>
</html>
